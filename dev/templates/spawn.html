{% extends "page.html" %}
{% if announcement_spawn is string %}
  {% set announcement = announcement_spawn %}
{% endif %}
{% block main %}
  <div class="container">
      <!-- Default spawner options -->
      {% block heading %}
      <div class="row text-center">
        <h1>Server Options</h1>
      </div>
      {% endblock heading %}
      <div class="row justify-content-center">
        <div class="col-md-8">
          {% if for_user and user.name != for_user.name -%}
            <p>Spawning server for {{ for_user.name }}</p>
          {% endif -%}
          {% if error_message -%}<p class="spawn-error-msg alert alert-danger">Error: {{ error_message }}</p>{% endif %}
          <form enctype="multipart/form-data"
              id="spawn_form"
              action="{{ url | safe }}"
              method="post"
              role="form">
            {{ spawner_options_form | safe }}
            <br>
            <div class="feedback-container">
              <button type="submit" class="btn btn-jupyter form-control">Start</button>
              <div class="feedback-widget hidden">
                <i class="fa fa-spinner"></i>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Custom GPU availability -->
      <div class="row justify-content-center mt-5">
        <div class="col-md-8 text-center">
          <h3>GPU Availability</h3>
          <table id="gpu-status-container" class="table table-bordered mx-auto" style="display: none; width: auto;">
              <thead>
              <tr>
                <th>Node Profile</th>
                <th>Available GPUs</th>
              </tr>
              </thead>
              <tbody><!-- dynamically updated by updateGpuStatus fn--></tbody>
          </table>
          <p class="mt-2">Your server will fail to launch if you request more <s>cats</s> GPUs than available!</p>
        </div>
      </div>
  </div>
{% endblock main %}

<!-- scripts -->
{% block script %}
  {{ super() }}
  <script>
    // setup onSubmit feedback
    $('form').submit((e) => {
      var form = $(e.target);
      form.find('.feedback-container>input').attr('disabled', true);
      form.find('.feedback-container>*').toggleClass('hidden');
      form.find('.feedback-widget>*').toggleClass('fa-pulse');
    });

    // function to update GPU status
    function updateGpuStatus() {
      fetch('http://172.29.180.91:5000/gpu_status_bynode')
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById('gpu-status-container');
          container.innerHTML = ''; // clear previous content

          // group data by GPU type
          const groupedData = {};
          data.forEach(gpuInfo => {
              if (!groupedData[gpuInfo.node_profile]) {
                  groupedData[gpuInfo.node_profile] = [];
              }
              groupedData[gpuInfo.node_profile].push(gpuInfo);
          });

          // table headers
          let tableContent = `
            <table border="1" style="border-collapse: collapse; width: 100%; text-align: center;">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Node</th>
                  <th>Available</th>
                </tr>
              </thead>
              <tbody>
          `;

          // populate info
          Object.entries(groupedData).forEach(([gpuType, nodes]) => {
            tableContent += `<tr><td rowspan="${nodes.length}" style="font-weight: bold; vertical-align: middle;">${gpuType}</td>`;
            
            nodes.forEach((gpuInfo, index) => {
              const availableGpus = gpuInfo.capacity - gpuInfo.total_gpu_requests;
              if (index > 0) tableContent += `<tr>`; // Start a new row if not the first node in the group
              tableContent += `
                <td>${gpuInfo.node_name}</td>
                <td>${availableGpus}&nbsp;${'ðŸ˜¸'.repeat(availableGpus)}</td>
              </tr>
              `;
            });
          });

          tableContent += `</tbody></table>`;

          // only show table once data is loaded
          container.innerHTML = tableContent;
          container.style.display = 'table';
        })
        .catch(error => {
          console.error('Error fetching GPU status:', error);
          const container = document.getElementById('gpu-status-container');
          container.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
        });
    }

    // update status every 10 seconds
    setInterval(updateGpuStatus, 10000);
    updateGpuStatus();
  </script>
{% endblock script %}